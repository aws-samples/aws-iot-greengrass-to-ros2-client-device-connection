{
    "Parameters" : {
        "ThingName" : {
            "Type" : "String"
        },
        "SerialNumber": {
            "Type": "String"
        },
        "DeviceLocation": {
            "Type": "String"
        }
    },
    "Resources" : {
        "thing" : {
            "Type" : "AWS::IoT::Thing",
            "Properties" : {
                "AttributePayload" : { 
                    "version" : "v1",
                    "serialNumber" : "serialNumber"
                },
                "ThingName" : {"Ref" : "ThingName"},
                "ThingTypeName" : {"Fn::Join":["",["ThingPrefix_",{"Ref":"SerialNumber"}]]},
                "ThingGroups" : ["v1-gg-server"]
            },
            "OverrideSettings" : {
                "AttributePayload" : "MERGE",
                "ThingTypeName" : "REPLACE",
                "ThingGroups" : "DO_NOTHING"
            }
        },
        "certificate" : {
            "Type" : "AWS::IoT::Certificate",
            "Properties" : {
                "CertificateId": {"Ref": "AWS::IoT::Certificate::Id"},
                "Status" : "Active"
            }
        },
        "policy" : {
            "Type" : "AWS::IoT::Policy",
            "Properties" : {
                "PolicyDocument" : {
                    "deviceGroups": {
                      "formatVersion": "2021-03-05",
                      "definitions": {
                        "MyDeviceGroup": {
                          "selectionRule": "thingName: {\"Ref\":\"ThingName\"}",
                          "policyName": "MultiClientDevicePolicy"
                        }
                      },
                      "policies": {
                        "MultiClientDevicePolicy": {
                          "AllowConnect": {
                            "statementDescription": "Allow client devices to connect.",
                            "operations": [
                              "mqtt:connect"
                            ],
                            "resources": [
                              "*"
                            ]
                          },
                          "AllowPublish": {
                            "statementDescription": "Allow client devices to publish to all topics.",
                            "operations": [
                              "mqtt:publish"
                            ],
                            "resources": [
                              "*"
                            ]
                          },
                          "AllowSubscribe": {
                            "statementDescription": "Allow client devices to subscribe to all topics.",
                            "operations": [
                              "mqtt:subscribe"
                            ],
                            "resources": [
                              "*"
                            ]
                          }
                        }
                      }
                    }
                  }
            }
        }
    }
}